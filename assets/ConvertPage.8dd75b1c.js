import{_ as D,r,a as v,o as M,u as j,$ as G,y as a,x as u,a0 as H,a1 as W,Z as x,a2 as P,v as z,a3 as A,aD as Q}from"./index.b327dff4.js";import{Q as Y}from"./QSpace.53215b27.js";import{Q as Z,a as J}from"./QHeader.f3de409e.js";import{d as K,c as B,Q as $,e as X}from"./QPage.d89aa49d.js";import{Q as U}from"./QSelect.4f854ae0.js";import{u as ee}from"./use-quasar.e67a33c2.js";import{_ as te}from"./PeopleDropdown.4a66e5cb.js";import{c as ae}from"./index.56516dd5.js";import{_ as le,a as oe}from"./TransactionList.8f887776.js";import"./QResizeObserver.994fd92b.js";import"./PersonItem.328be996.js";import"./focusout.d17da46a.js";import"./scroll.1ecdcb10.js";import"./QDialog.5d8f34d5.js";import"./rtl.276c3f1b.js";import"./QSlideItem.615da973.js";const ke=Object.assign({name:"ConvertPage"},{__name:"ConvertPage",setup(se){const o=D(),F=W(),d=ee(),c=r(null),q=r(null),i=r(o.user.id),y=v(()=>o.personId2Idx(i.value)),g=ae.data.map(t=>({label:`${t.code} - ${t.currency}`,value:t.code})),p=r(g),b=r(null),w=v(()=>Q.getSummary(o.currentSheetResults,y.value)),C=g.filter(t=>Object.keys(w.value.totals).includes(t.value)),f=r(C),h=r(null),m=Object.keys(w.value.totals),n=r(m.length>0?m[0]:"USD"),s=r(m.length>1?m[1]:m.length>0?m[0]:"USD"),T=()=>{F.go(-1)},I=()=>{Object.keys(w.value.totals).includes(s.value)?[n.value,s.value]=[s.value,n.value]:d.notify({message:`Cannot swap: You don't have a balance in ${s.value}`,color:"negative"})},R=(t,e)=>{if(t===""){e(()=>{p.value=g});return}s.value="";const l=t.toLowerCase();e(()=>{const _=g.filter(V=>V.value.toLowerCase().includes(l));p.value=_,p.value.length===1&&(s.value=p.value[0].value,b.value&&(b.value.updateInputValue(""),setTimeout(()=>{b.value.hidePopup()},0)))})},E=(t,e)=>{if(t===""){e(()=>{f.value=C});return}n.value="";const l=t.toLowerCase();e(()=>{const _=C.filter(V=>V.value.toLowerCase().includes(l));f.value=_,f.value.length===1&&(n.value=f.value[0].value,h.value&&(h.value.updateInputValue(""),setTimeout(()=>{h.value.hidePopup()},0)))})};M(async()=>{const t="https://cdn.jsdelivr.net/gh/ismartcoding/currency-api/latest/data.json";try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);c.value=await e.json()}catch(e){d.notify({message:e.message||e,color:"negative"})}});const k=v(()=>c.value?c.value.quotes[n.value]?c.value.quotes[s.value]?c.value.quotes[s.value]/c.value.quotes[n.value]:(d.notify(`Unknown currency ${s.value}!`),1):(d.notify(`Unknown currency ${n.value}!`),1):1),S=v(()=>{let t=`\u{1F916} settle ${o.getName(i.value)}`;const e=o.makeEquivalentTransactionBatch(n.value,y.value,t);t=`\u{1F916} convert ${o.getName(i.value)}`;const l=o.makeEquivalentTransactionBatch(n.value,y.value,t,-k.value,s.value);return{...e,...l}}),O=v(()=>{const t=o.getEditableCurrentSheetResults();return Q.applyTransactions(t,S.value,o.currentSheetPeople.length||0),t}),L=v(()=>Q.getSummary(O.value,y.value)),N=async()=>{try{await o.addTransactions(S.value),T()}catch(t){d.notify({message:t.message||t,color:"negative"});return}};return(t,e)=>(j(),G(H,null,[a(Z,{elevated:"",class:"bg-primary text-white"},{default:u(()=>[a(J,null,{default:u(()=>[a(x,{flat:"",icon:"arrow_back",onClick:T,"aria-label":"Go Back",class:"bg-white text-primary"}),a(Y),a(x,{flat:"",icon:"done",label:"Confirm",onClick:N,class:"q-ml-md bg-secondary text-white","aria-label":"Save"})]),_:1})]),_:1}),a(K,null,{default:u(()=>[a(B,{class:"q-my-md q-mr-md q-ml-md"},{default:u(()=>[a($,{class:"full-width"},{default:u(()=>[P(o).currentSheet?(j(),z(te,{key:0,class:"full-width",modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=l=>i.value=l),people:P(o).currentSheet.people,"sorted-people":P(o).currentSheetPeople},null,8,["modelValue","people","sorted-people"])):A("",!0)]),_:1}),a($,{class:"full-width row justify-center"},{default:u(()=>[a(U,{class:"q-mr-md",ref_key:"fromCurrencySelect",ref:h,label:"From",filled:"",modelValue:n.value,"onUpdate:modelValue":e[1]||(e[1]=l=>n.value=l),options:f.value,"option-label":"label","option-value":"value","option-slot":"","emit-value":"","use-input":"","input-debounce":"0",onFilter:E,style:{maxWidth:"130px"}},null,8,["modelValue","options"]),a(x,{class:"q-mr-md",icon:"swap_horiz",onClick:I}),a(U,{ref_key:"currencySelect",ref:b,label:"To",filled:"",modelValue:s.value,"onUpdate:modelValue":e[2]||(e[2]=l=>s.value=l),options:p.value,"option-label":"label","option-value":"value","option-slot":"","emit-value":"","use-input":"","input-debounce":"0",onFilter:R,style:{maxWidth:"130px"}},null,8,["modelValue","options"])]),_:1})]),_:1}),a(B,null,{default:u(()=>[a($,{class:"full-width row justify-center"},{default:u(()=>[a(X,{ref_key:"conversionInputRef",ref:q,outlined:"",modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=l=>k.value=l),modelModifiers:{number:!0},type:"number",min:"0",label:"Conversion Rate","input-class":"text-center",onFocus:e[4]||(e[4]=l=>q.value.select())},null,8,["modelValue"])]),_:1})]),_:1}),a(le,{summaries:L.value,selectedPerson:i.value},null,8,["summaries","selectedPerson"]),a(oe,{transactions:S.value,selectedPerson:i.value,disableEdit:!0,disableRemove:!0},null,8,["transactions","selectedPerson"])]),_:1})],64))}});export{ke as default};
