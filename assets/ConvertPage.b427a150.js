import{O as M,r,a as v,o as D,u as U,P as G,y as a,x as u,S as H,T as W,N as P,U as Q,v as z,V as A,aC as x}from"./index.60e6e8a1.js";import{Q as Y}from"./QSpace.3c586704.js";import{Q as J,a as K}from"./QHeader.115cbbde.js";import{a as j,Q as q,b as X}from"./QCard.bb53101c.js";import{Q as B}from"./QSelect.e5444f59.js";import{Q as Z,b as ee}from"./QPage.d94a517d.js";import{_ as te}from"./PeopleDropdown.5cd6d3cf.js";import{c as ae}from"./index.56516dd5.js";import{_ as le,a as oe}from"./TransactionList.c7e97794.js";import"./QResizeObserver.00fe55ea.js";import"./PersonItem.d6e75794.js";import"./selection.a9ba7428.js";import"./focusout.b670c056.js";import"./scroll.cac68e2d.js";import"./QDialog.dcc50afc.js";import"./rtl.276c3f1b.js";import"./QSlideItem.3021156c.js";import"./use-render-cache.770e5fe8.js";const _e=Object.assign({name:"ConvertPage"},{__name:"ConvertPage",setup(se){const o=M(),F=W(),d=ee(),c=r(null),T=r(null),i=r(o.user.id),y=v(()=>o.personId2Idx(i.value)),g=ae.data.map(t=>({label:`${t.code} - ${t.currency}`,value:t.code})),p=r(g),b=r(null),h=v(()=>x.getSummary(o.currentSheetResults,y.value)),w=g.filter(t=>Object.keys(h.value.totals).includes(t.value)),f=r(w),C=r(null),m=Object.keys(h.value.totals),n=r(m.length>0?m[0]:"USD"),s=r(m.length>1?m[1]:m.length>0?m[0]:"USD"),$=()=>{F.go(-1)},I=()=>{Object.keys(h.value.totals).includes(s.value)?[n.value,s.value]=[s.value,n.value]:d.notify({message:`Cannot swap: You don't have a balance in ${s.value}`,color:"negative"})},R=(t,e)=>{if(t===""){e(()=>{p.value=g});return}s.value="";const l=t.toLowerCase();e(()=>{const _=g.filter(V=>V.value.toLowerCase().includes(l));p.value=_,p.value.length===1&&(s.value=p.value[0].value,b.value&&(b.value.updateInputValue(""),setTimeout(()=>{b.value.hidePopup()},0)))})},O=(t,e)=>{if(t===""){e(()=>{f.value=w});return}n.value="";const l=t.toLowerCase();e(()=>{const _=w.filter(V=>V.value.toLowerCase().includes(l));f.value=_,f.value.length===1&&(n.value=f.value[0].value,C.value&&(C.value.updateInputValue(""),setTimeout(()=>{C.value.hidePopup()},0)))})};D(async()=>{const t="https://cdn.jsdelivr.net/gh/ismartcoding/currency-api/latest/data.json";try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);c.value=await e.json()}catch(e){d.notify({message:e.message||e,color:"negative"})}});const k=v(()=>c.value?c.value.quotes[n.value]?c.value.quotes[s.value]?c.value.quotes[s.value]/c.value.quotes[n.value]:(d.notify(`Unknown currency ${s.value}!`),1):(d.notify(`Unknown currency ${n.value}!`),1):1),S=v(()=>{let t=`\u{1F916} settle ${o.getName(i.value)}`;const e=o.makeEquivalentTransactionBatch(n.value,y.value,t);t=`\u{1F916} convert ${o.getName(i.value)}`;const l=o.makeEquivalentTransactionBatch(n.value,y.value,t,-k.value,s.value);return{...e,...l}}),E=v(()=>{const t=o.getEditableCurrentSheetResults();return x.applyTransactions(t,S.value,o.currentSheetPeople.length||0),t}),N=v(()=>x.getSummary(E.value,y.value)),L=async()=>{try{await o.addTransactions(S.value),$()}catch(t){d.notify({message:t.message||t,color:"negative"});return}};return(t,e)=>(U(),G(H,null,[a(J,{elevated:"",class:"bg-primary text-white"},{default:u(()=>[a(K,null,{default:u(()=>[a(P,{flat:"",icon:"arrow_back",onClick:$,"aria-label":"Go Back",class:"bg-white text-primary"}),a(Y),a(P,{flat:"",icon:"done",label:"Confirm",onClick:L,class:"q-ml-md bg-secondary text-white","aria-label":"Save"})]),_:1})]),_:1}),a(Z,null,{default:u(()=>[a(j,{class:"q-my-md q-mr-md q-ml-md"},{default:u(()=>[a(q,{class:"full-width"},{default:u(()=>[Q(o).currentSheet?(U(),z(te,{key:0,class:"full-width",modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=l=>i.value=l),people:Q(o).currentSheet.people,"sorted-people":Q(o).currentSheetPeople},null,8,["modelValue","people","sorted-people"])):A("",!0)]),_:1}),a(q,{class:"full-width row justify-center"},{default:u(()=>[a(B,{class:"q-mr-md",ref_key:"fromCurrencySelect",ref:C,label:"From",filled:"",modelValue:n.value,"onUpdate:modelValue":e[1]||(e[1]=l=>n.value=l),options:f.value,"option-label":"label","option-value":"value","option-slot":"","emit-value":"","use-input":"","input-debounce":"0",onFilter:O,style:{maxWidth:"110px"}},null,8,["modelValue","options"]),a(P,{class:"q-mr-md",icon:"swap_horiz",onClick:I}),a(B,{ref_key:"currencySelect",ref:b,label:"To",filled:"",modelValue:s.value,"onUpdate:modelValue":e[2]||(e[2]=l=>s.value=l),options:p.value,"option-label":"label","option-value":"value","option-slot":"","emit-value":"","use-input":"","input-debounce":"0",onFilter:R,style:{maxWidth:"110px"}},null,8,["modelValue","options"])]),_:1})]),_:1}),a(j,null,{default:u(()=>[a(q,{class:"full-width row justify-center"},{default:u(()=>[a(X,{ref_key:"conversionInputRef",ref:T,outlined:"",modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=l=>k.value=l),modelModifiers:{number:!0},type:"number",min:"0",label:"Conversion Rate","input-class":"text-center",onFocus:e[4]||(e[4]=l=>T.value.select())},null,8,["modelValue"])]),_:1})]),_:1}),a(le,{summaries:N.value,selectedPerson:i.value},null,8,["summaries","selectedPerson"]),a(oe,{transactions:S.value,selectedPerson:i.value,disableEdit:!0,disableRemove:!0},null,8,["transactions","selectedPerson"])]),_:1})],64))}});export{_e as default};
